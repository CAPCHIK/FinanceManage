@page "/purchases/{chatId:long}"
@attribute [Authorize]

@using AntDesign.Charts

@inject IMediator mediator

@if (ex is ForbidException)
{
    <AntDesign.Text>У вас нет доступа к информации о данном канале</AntDesign.Text>
}
else if (ex is not null)
{
    <Tooltip Title="@($"{ex.GetType().FullName} : {ex.Message}")" Placement="@PlacementType.Bottom">
        <AntDesign.Text>Непредвиденная ошибка. Пожалуйста, попробуйте позже.</AntDesign.Text>
    </Tooltip>
}
else if (data is null)
{
    <Spin Spinning="true" Tip="Загрузка данных"></Spin>
}
else
{
    <StackedArea @ref="chart4" TItem="GraphItem" Config="config4" Data="data" />
}

@code {

    [Parameter]
    public long ChatId { get; set; }

    private Exception ex;
    private List<GraphItem> data;


    private async Task LoadData()
    {
        ex = default;
        data = default;
        try
        {
            var response = await mediator.Send(new GetAllPurchases.Command(ChatId));
            var categories = response.Select(r => r.Category.Split(' ')[0]).Distinct().ToList();

            var result = response
                .Select(r => (date: r.Date.ToString("yyyy-MM-dd"), item: r))
                .GroupBy(r => r.date)
                .OrderBy(g => g.Key)
                .Select(g => (date: g.Key, items: g.GroupBy(itemInDay => itemInDay.item.Category.Split(' ')[0]).ToDictionary(dayGroup => dayGroup.Key, dayGroup => dayGroup.Sum(dg => dg.item.Price))))
                .Select(g => (date: g.date, items: categories.Select(c => (category: c, price: g.items.TryGetValue(c, out var price) ? price : 0))))
                .SelectMany(g => g.items.Select(i => new GraphItem
                {
                    Date = g.date,
                    Category = i.category,
                    Value = i.price
                }))
                .ToList();

            data = result;
        }
        catch (Exception ex)
        {
            this.ex = ex;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender)
        {
            await LoadData();
            StateHasChanged();
        }
    }


    class GraphItem
    {
        public string Date { get; set; }
        public double Value { get; set; }
        public string Category { get; set; }
    }
    IChartComponent chart4;

    readonly StackedAreaConfig config4 = new StackedAreaConfig
    {
        Title = new AntDesign.Charts.Title
        {
            Visible = true,
            Text = "Покупки за все время"
        },
        XField = "date",
        YField = "value",
        SeriesField = "category",
        XAxis = new ValueCatTimeAxis
        {
            Type = "dateTime",
            Mask = "YYYY-MM-D",
            Visible = true,
            Label = new BaseAxisLabel
            {
                Visible = true,
                AutoRotate = true,
                AutoHide = true
            }
        },
        Interactions = new Interaction[]
        {
            new Interaction
            {
                Type="slider",
                Cfg = new
                {
                    start = 0,
                    end = 1,
                }
            }
        }
    };
}
